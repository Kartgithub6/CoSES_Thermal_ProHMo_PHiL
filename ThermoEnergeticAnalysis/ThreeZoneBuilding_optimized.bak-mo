within CoSES_Thermal_ProHMo_PHiL.ThermoEnergeticAnalysis;
model ThreeZoneBuilding_optimized
  "Three-zone building with OPTIMIZED hydraulic topology - Living gets priority"

  inner Modelica.Fluid.System system(
    energyDynamics=Modelica.Fluid.Types.Dynamics.SteadyStateInitial,
    massDynamics=Modelica.Fluid.Types.Dynamics.SteadyStateInitial,
    T_ambient=278.15)
    annotation(Placement(visible=true, transformation(origin={-170,170}, extent={{-10,-10},{10,10}}, rotation=0)));

  replaceable package Medium = Modelica.Media.Water.StandardWater;
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FLUID PORTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Modelica.Fluid.Interfaces.FluidPort_a port_a(redeclare package Medium=Medium)
    "Supply water inlet"
    annotation(Placement(visible=true, transformation(origin={-200,60},extent={{-10,-10},{10,10}}, rotation=0),
      iconTransformation(origin={-100,60}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Fluid.Interfaces.FluidPort_b port_b(redeclare package Medium=Medium)
    "Return water outlet"
    annotation(Placement(visible=true, transformation(origin={-200,-62},  extent={{-10,-10},{10,10}}, rotation=0),
      iconTransformation(origin={-100,-60}, extent={{-10,-10},{10,10}}, rotation=0)));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // OUTPUTS - System Performance
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Modelica.Blocks.Interfaces.RealOutput qvRef
    "Total volume flow rate [mÂ³/s]"
    annotation(Placement(visible=true, transformation(origin={210,-100}, extent={{-10,-10},{10,10}}, rotation=0),
      iconTransformation(origin={110,-70}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Interfaces.RealOutput TZone_cellar
    "Cellar temperature [K]"
    annotation(Placement(visible=true, transformation(origin={210,140}, extent={{-10,-10},{10,10}}, rotation=0),
      iconTransformation(origin={110,60}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Interfaces.RealOutput TZone_living
    "Living room temperature [K]"
    annotation(Placement(visible=true, transformation(origin={210,40}, extent={{-10,-10},{10,10}}, rotation=0),
      iconTransformation(origin={110,30}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Interfaces.RealOutput TZone_roof
    "Roof office temperature [K]"
    annotation(Placement(visible=true, transformation(origin={210,-60}, extent={{-10,-10},{10,10}}, rotation=0),
      iconTransformation(origin={110,0}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Interfaces.RealOutput valve_cellar_opening
    "Cellar valve position [0-1]"
    annotation(Placement(visible=true, transformation(origin={210,100}, extent={{-10,-10},{10,10}}, rotation=0),
      iconTransformation(origin={110,-30}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Interfaces.RealOutput valve_living_opening
    "Living valve position [0-1]"
    annotation(Placement(visible=true, transformation(origin={210,0}, extent={{-10,-10},{10,10}}, rotation=0),
      iconTransformation(origin={110,-50}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Interfaces.RealOutput valve_roof_opening
    "Roof valve position [0-1]"
    annotation(Placement(visible=true, transformation(origin={210,-140}, extent={{-10,-10},{10,10}}, rotation=0),
      iconTransformation(origin={110,-90}, extent={{-10,-10},{10,10}}, rotation=0)));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INPUTS - Occupancy
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Modelica.Blocks.Interfaces.RealInput nPersons_cellar(start=0)
    "Number of people in cellar"
    annotation(Placement(visible=true, transformation(origin={-220,180}, extent={{-10,-10},{10,10}}, rotation=0),
      iconTransformation(origin={-110,80}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Interfaces.RealInput nPersons_living(start=0)
    "Number of people in living room"
    annotation(Placement(visible=true, transformation(origin={-220,140}, extent={{-10,-10},{10,10}}, rotation=0),
      iconTransformation(origin={-110,50}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Interfaces.RealInput nPersons_roof(start=0)
    "Number of people in roof office"
    annotation(Placement(visible=true, transformation(origin={-220,118}, extent={{-10,-10},{10,10}}, rotation=0),
      iconTransformation(origin={-110,20}, extent={{-10,-10},{10,10}}, rotation=0)));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // INPUTS - Appliance Loads
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Modelica.Blocks.Interfaces.RealInput P_appliances_cellar_W(start=50)
    "Appliance power in cellar [W]"
    annotation(Placement(visible=true, transformation(origin={230,180}, extent={{-10,-10},{10,10}}, rotation=180),
      iconTransformation(origin={110,80}, extent={{-10,-10},{10,10}}, rotation=180)));

  Modelica.Blocks.Interfaces.RealInput P_appliances_living_W(start=200)
    "Appliance power in living room [W]"
    annotation(Placement(visible=true, transformation(origin={230,140}, extent={{-10,-10},{10,10}}, rotation=180),
      iconTransformation(origin={110,50}, extent={{-10,-10},{10,10}}, rotation=180)));

  Modelica.Blocks.Interfaces.RealInput P_appliances_roof_W(start=50)
    "Appliance power in roof office [W]"
    annotation(Placement(visible=true, transformation(origin={230,100}, extent={{-10,-10},{10,10}}, rotation=180),
      iconTransformation(origin={110,20}, extent={{-10,-10},{10,10}}, rotation=180)));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PARAMETERS - Zone Geometry
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  parameter Modelica.Units.SI.Area AZone_cellar=80 "Cellar floor area";
  parameter Modelica.Units.SI.Area AZone_living=100 "Living room floor area";
  parameter Modelica.Units.SI.Area AZone_roof=60 "Roof office floor area";
  parameter Modelica.Units.SI.Length hZone_cellar=2.2 "Cellar height";
  parameter Modelica.Units.SI.Length hZone_living=2.5 "Living room height";
  parameter Modelica.Units.SI.Length hZone_roof=2.3 "Roof office height";

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PARAMETERS - Temperature Setpoints
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  parameter Modelica.Units.SI.Temperature TRef_cellar=291.15 "Cellar setpoint 18Â°C";
  parameter Modelica.Units.SI.Temperature TRef_living=293.15 "Living setpoint 20Â°C";
  parameter Modelica.Units.SI.Temperature TRef_roof=293.15 "Roof setpoint 20Â°C";
  parameter Modelica.Units.SI.Temperature TZoneInit_cellar=291.15 "Cellar initial temperature";
  parameter Modelica.Units.SI.Temperature TZoneInit_living=293.15 "Living initial temperature";
  parameter Modelica.Units.SI.Temperature TZoneInit_roof=290.15 "Roof initial temperature";

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PARAMETERS - Control
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  parameter Boolean cellarHeat=true "Enable cellar heating";
  parameter Boolean roofHeat=true "Enable roof heating";
  parameter Real k_PI=0.3 "PI proportional gain";
  parameter Modelica.Units.SI.Time Ti_PI=500 "PI integral time";

  // â­â­â­ OPTIMIZED VALVE MINIMUMS - Key to preventing overheating!
  parameter Real yMin_roof=0.02 " 18 Jan Reduced to 3% Roof valve minimum 8%";
  parameter Real yMin_living=0.02 "Living valve minimum 3% (priority zone)";
  parameter Real yMin_cellar=0.01 "Reduced from 5% to 2% Cellar valve minimum 5% (REDUCED from 20%!)";

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FLUID SENSORS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Modelica.Fluid.Sensors.VolumeFlowRate qvMedium(redeclare package Medium=Medium)
    "Volumetric flow rate sensor"
    annotation(Placement(visible=true, transformation(origin={-168,60},extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Fluid.Sensors.TemperatureTwoPort TMedium(redeclare package Medium=Medium)
    "Supply temperature sensor"
    annotation(Placement(visible=true, transformation(origin={-136,60},extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Fluid.Sensors.TemperatureTwoPort TReturn(redeclare package Medium=Medium)
    "Return temperature sensor"
    annotation(Placement(visible=true, transformation(origin={160,-100}, extent={{-10,-10},{10,10}}, rotation=0)));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HYDRAULIC TOPOLOGY - OPTIMIZED DESIGN
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Main tee: Splits flow between LIVING (priority) and CELLAR+ROOF (shared)
  Modelica.Fluid.Fittings.TeeJunctionIdeal teeMain(redeclare package Medium=Medium)
    "Main flow splitter: Living vs Cellar+Roof"
    annotation(Placement(visible=true, transformation(origin={-110,100},
                                                                       extent={{-10,-10},{10,10}}, rotation=0)));

  // Secondary tee: Splits remaining flow between cellar and roof
  Modelica.Fluid.Fittings.TeeJunctionIdeal teeCellarRoof(redeclare package Medium=Medium)
    "Secondary splitter: Cellar vs Roof"
    annotation(Placement(visible=true, transformation(origin={-70,75}, extent={{-10,-10},{10,10}}, rotation=0)));

  // Merge tee: Combines cellar and roof returns
  Modelica.Fluid.Fittings.TeeJunctionIdeal teeMergeCellarRoof(redeclare package Medium=Medium)
    "Merge cellar and roof returns"
    annotation(Placement(visible=true, transformation(origin={90,75}, extent={{-10,10},{10,-10}}, rotation=0)));

  // Final merge: Combines all returns
  Modelica.Fluid.Fittings.TeeJunctionIdeal teeMergeMain(redeclare package Medium=Medium)
    "Merge all zone returns"
    annotation(Placement(visible=true, transformation(origin={130,-100}, extent={{-10,10},{10,-10}}, rotation=0)));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONTROL VALVES
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Modelica.Fluid.Valves.ValveLinear valve_living(
    redeclare package Medium=Medium,
    dp_nominal=10000,
    m_flow_nominal=0.06,
    m_flow(start=0.02),
    m_flow_small=0.001)
    "Living room control valve (PRIORITY)"
    annotation(Placement(visible=true, transformation(origin={-50,0}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Fluid.Valves.ValveLinear valve_cellar(
    redeclare package Medium=Medium,
    dp_nominal=10000,
    m_flow_nominal=0.04,
    m_flow(start=0.008),
    m_flow_small=0.001)
    "Cellar control valve"
    annotation(Placement(visible=true, transformation(origin={-50,125}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Fluid.Valves.ValveLinear valve_roof(
    redeclare package Medium=Medium,
    dp_nominal=10000,
    m_flow_nominal=0.04,
    m_flow(start=0.008),
    m_flow_small=0.001)
    "Roof office control valve"
    annotation(Placement(visible=true, transformation(origin={-50,25}, extent={{-10,-10},{10,10}}, rotation=0)));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PI CONTROLLERS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Modelica.Blocks.Continuous.LimPID PI_living(
    controllerType=Modelica.Blocks.Types.SimpleController.PI,
    k=k_PI,
    Ti=Ti_PI,
    yMax=1.0,
    yMin=yMin_living)
    "Living room temperature controller"
    annotation(Placement(visible=true, transformation(origin={-96,22}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Continuous.LimPID PI_cellar(
    controllerType=Modelica.Blocks.Types.SimpleController.PI,
    k=k_PI,
    Ti=Ti_PI,
    yMax=if cellarHeat then 1.0 else yMin_cellar,
    yMin=yMin_cellar)
    "Cellar temperature controller"
    annotation(Placement(visible=true, transformation(origin={-90,150}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Continuous.LimPID PI_roof(
    controllerType=Modelica.Blocks.Types.SimpleController.PI,
    k=k_PI,
    Ti=Ti_PI,
    yMax=if roofHeat then 1.0 else yMin_roof,
    yMin=yMin_roof)
    "Roof office temperature controller"
    annotation(Placement(visible=true, transformation(origin={-90,55}, extent={{-10,-10},{10,10}}, rotation=0)));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HYDRONIC SUBSYSTEMS with RIGHT-SIZED radiators
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  CoSES_Thermal_ProHMo_PHiL.HydronicSystem.SystemWithZoneAndHydronics_optimized roof_hydSys(
    redeclare package Medium=Medium,
    Q_flow_nominal=2000,  // Roof: 2500W (adequate)
    T_a_nominal=343.15,
    T_b_nominal=323.15,
    TAir_nominal=293.15,
    fraRad=0.35,
    nEle=5,
    T_start=323.15,
    p_start=200000)
    "Roof office hydronic system"
    annotation(Placement(visible=true, transformation(origin={0,35}, extent={{-20,-20},{20,20}}, rotation=0)));

  CoSES_Thermal_ProHMo_PHiL.HydronicSystem.SystemWithZoneAndHydronics_optimized living_hydSys(
    redeclare package Medium=Medium,
    Q_flow_nominal=3500,  // Living: 3500W (priority zone)
    T_a_nominal=343.15,
    T_b_nominal=323.15,
    TAir_nominal=293.15,
    fraRad=0.35,
    nEle=5,
    T_start=323.15,
    p_start=200000)
    "Living room hydronic system"
    annotation(Placement(visible=true, transformation(origin={0,-12},extent={{-20,-20},{20,20}}, rotation=0)));

  CoSES_Thermal_ProHMo_PHiL.HydronicSystem.SystemWithZoneAndHydronics_optimized cellar_hydSys(
    redeclare package Medium=Medium,
    Q_flow_nominal=1500,  // Reduced from 2500 W Cellar: 2500W (REDUCED from 4000W!)
    T_a_nominal=343.15,
    T_b_nominal=323.15,
    TAir_nominal=291.15,
    fraRad=0.35,
    nEle=5,
    T_start=323.15,
    p_start=200000)
    "Cellar hydronic system"
    annotation(Placement(visible=true, transformation(origin={0,135}, extent={{-20,-20},{20,20}}, rotation=0)));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // BUILDING ZONES - Using BuildingSystem library
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  BuildingSystem.Building.HeatedZone cellar_zone(
    ZoneIndex=1,
    NumberZones=3,
    AZone=AZone_cellar,
    hZone=hZone_cellar,
    TZoneInit=TZoneInit_cellar,
    infiltrationRate=0.15,  // Low infiltration (underground)
    occupancyLoad=50,
    applianceLoad=50)
    "Cellar thermal zone"
    annotation(Placement(visible=true, transformation(origin={70,135}, extent={{-20,-20},{20,20}}, rotation=0)));

  BuildingSystem.Building.HeatedZone living_zone(
    ZoneIndex=2,
    NumberZones=3,
    AZone=AZone_living,
    hZone=hZone_living,
    TZoneInit=TZoneInit_living,
    infiltrationRate=0.30,  // Moderate infiltration
    occupancyLoad=200,
    applianceLoad=150)
    "Living room thermal zone"
    annotation(Placement(visible=true, transformation(origin={70,32}, extent={{-20,-20},{20,20}}, rotation=0)));

  BuildingSystem.Building.HeatedZone roof_zone(
    ZoneIndex=3,
    NumberZones=3,
    AZone=AZone_roof,
    hZone=hZone_roof,
    TZoneInit=TZoneInit_roof,
    infiltrationRate=0.20,  // Low-moderate infiltration
    occupancyLoad=100,
    applianceLoad=50)
    "Roof office thermal zone"
    annotation(Placement(visible=true, transformation(origin={72,-59},extent={{-20,-20},{20,20}}, rotation=0)));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // SETPOINT CONSTANTS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Modelica.Blocks.Sources.Constant TRefConst_cellar(k=TRef_cellar)
    "Cellar temperature setpoint"
    annotation(Placement(visible=true, transformation(origin={-160,150}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Sources.Constant TRefConst_living(k=TRef_living)
    "Living temperature setpoint"
    annotation(Placement(visible=true, transformation(origin={-158,-42},extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Sources.Constant TRefConst_roof(k=TRef_roof)
    "Roof temperature setpoint"
    annotation(Placement(visible=true, transformation(origin={-152,1},  extent={{-10,-10},{10,10}}, rotation=0)));

  // Window shading (disabled for now)
  Modelica.Blocks.Sources.Constant WindowShadingConst_cellar[3](each k=0)
    annotation(Placement(visible=true, transformation(origin={50,150}, extent={{-10,-10},{10,10}}, rotation=0)));
  Modelica.Blocks.Sources.Constant WindowShadingConst_living[3](each k=0)
    annotation(Placement(visible=true, transformation(origin={50,30}, extent={{-10,-10},{10,10}}, rotation=0)));
  Modelica.Blocks.Sources.Constant WindowShadingConst_roof[3](each k=0)
    annotation(Placement(visible=true, transformation(origin={50,55}, extent={{-10,-10},{10,10}}, rotation=0)));

  // Solar radiation (disabled for now)
  Modelica.Blocks.Sources.Constant Q_radiation_cellar(k=0)
    annotation(Placement(visible=true, transformation(origin={30,160}, extent={{-10,-10},{10,10}}, rotation=0)));
  Modelica.Blocks.Sources.Constant Q_radiation_living(k=0)
    annotation(Placement(visible=true, transformation(origin={30,40}, extent={{-10,-10},{10,10}}, rotation=0)));
  Modelica.Blocks.Sources.Constant Q_radiation_roof(k=0)
    annotation(Placement(visible=true, transformation(origin={30,65}, extent={{-10,-10},{10,10}}, rotation=0)));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FLOW RATE APPROXIMATION
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Modelica.Blocks.Math.Add3 qvSum
    "Sum of all zone flow rates"
    annotation(Placement(visible=true, transformation(origin={170,-100}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Math.Gain qv_cellar_approx(k=0.001)
    "Cellar flow approximation"
    annotation(Placement(visible=true, transformation(origin={130,150}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Math.Gain qv_living_approx(k=0.001)
    "Living flow approximation"
    annotation(Placement(visible=true, transformation(origin={130,30}, extent={{-10,-10},{10,10}}, rotation=0)));

  Modelica.Blocks.Math.Gain qv_roof_approx(k=0.001)
    "Roof flow approximation"
    annotation(Placement(visible=true, transformation(origin={130,55}, extent={{-10,-10},{10,10}}, rotation=0)));

equation
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HYDRAULIC CONNECTIONS - OPTIMIZED TOPOLOGY
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Supply path: Port_a â†’ Sensors â†’ Main tee
  connect(port_a, qvMedium.port_a)
    annotation(Line(points={{-200,60},{-178,60}},
                                                color={0,127,255}, thickness=0.5));
  connect(qvMedium.port_b, TMedium.port_a)
    annotation(Line(points={{-158,60},{-146,60}},
                                                color={0,127,255}, thickness=0.5));
  connect(TMedium.port_b, teeMain.port_1)
    annotation(Line(points={{-126,60},{-118,60},{-118,84},{-126,84},{-126,100},{
          -120,100}},                           color={0,127,255}, thickness=0.5));

  // â­ LIVING PRIORITY: Direct connection from main tee
  connect(teeMain.port_2, valve_living.port_a)
    annotation(Line(points={{-100,100},{-54,100},{-54,42},{-66,42},{-66,0},{-60,
          0}},                                                                color={0,127,255}, thickness=0.5));
  connect(valve_living.port_b, living_hydSys.port_a)
    annotation(Line(points={{-40,0},{-30,0},{-30,-12},{-20,-12}},
                                                       color={0,127,255}, thickness=0.5));

  // â­ CELLAR+ROOF SHARED: Secondary branch from main tee
  connect(teeMain.port_3, teeCellarRoof.port_1)
    annotation(Line(points={{-110,110},{-110,114},{-86,114},{-86,75},{-80,75}},
                                                           color={0,127,255}));
  connect(teeCellarRoof.port_2, valve_cellar.port_a)
    annotation(Line(points={{-60,75},{-60,125},{-60,125}}, color={0,127,255}));
  connect(teeCellarRoof.port_3, valve_roof.port_a)
    annotation(Line(points={{-70,85},{-70,25},{-60,25}}, color={0,127,255}));
  connect(valve_cellar.port_b, cellar_hydSys.port_a)
    annotation(Line(points={{-40,125},{-30,125},{-30,135},{-20,135}}, color={0,127,255}));
  connect(valve_roof.port_b, roof_hydSys.port_a)
    annotation(Line(points={{-40,25},{-30,25},{-30,35},{-20,35}}, color={0,127,255}));

  // Return path merging
  connect(cellar_hydSys.port_b, teeMergeCellarRoof.port_2)
    annotation(Line(points={{20,135},{50,135},{50,75},{100,75}},color={0,127,255}));
  connect(roof_hydSys.port_b, teeMergeCellarRoof.port_3)
    annotation(Line(points={{20,35},{50,35},{50,65},{90,65}}, color={0,127,255}));
  connect(teeMergeCellarRoof.port_1, teeMergeMain.port_3)
    annotation(Line(points={{80,75},{130,75},{130,-110}}, color={0,127,255}));
  connect(living_hydSys.port_b, teeMergeMain.port_2)
    annotation(Line(points={{20,-12},{40,-12},{40,-118},{140,-118},{140,-100}},
                                                                   color={0,127,255}));
  connect(teeMergeMain.port_1, TReturn.port_a)
    annotation(Line(points={{120,-100},{150,-100}}, color={0,127,255}, thickness=0.5));
  connect(TReturn.port_b, port_b)
    annotation(Line(points={{170,-100},{170,-120},{-200,-120},{-200,-62}},
                                                     color={0,127,255}, thickness=0.5));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ZONE THERMAL CONNECTIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  connect(cellar_hydSys.port_zone, cellar_zone.heatPort)
    annotation(Line(points={{0,154},{0,160},{50,160},{50,143.4},{48.8,143.4}},
                                                                         color={191,0,0}));
  connect(living_hydSys.port_zone, living_zone.heatPort)
    annotation(Line(points={{0,8},{-26,8},{-26,28},{-32,28},{-32,84},{48.8,84},{
          48.8,40.4}},                                              color={191,0,0}));
  connect(roof_hydSys.port_zone, roof_zone.heatPort)
    annotation(Line(points={{0,55},{0,64},{-26,64},{-26,54},{-72,54},{-72,-46},{
          42,-46},{42,-50.6},{50.8,-50.6}},                         color={191,0,0}));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // CONTROL CONNECTIONS - PI Controllers
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Cellar control loop
  connect(TRefConst_cellar.y, PI_cellar.u_s)
    annotation(Line(points={{-149,150},{-102,150}}, color={0,0,127}));
  connect(cellar_zone.TZone, PI_cellar.u_m)
    annotation(Line(points={{62,114.6},{110,114.6},{110,130},{-90,130},{-90,138}},
                                                                               color={0,0,127}));
  connect(PI_cellar.y, valve_cellar.opening)
    annotation(Line(points={{-79,150},{-70,150},{-70,140},{-50,140},{-50,133}}, color={0,0,127}));
  connect(TRefConst_cellar.y, cellar_zone.TZoneRef)
    annotation(Line(points={{-149,150},{-140,150},{-140,180},{100,180},{100,143},
          {89.6,143}},                                                                      color={0,0,127}));

  // Living control loop
  connect(TRefConst_living.y, PI_living.u_s)
    annotation(Line(points={{-147,-42},{-142,-42},{-142,-16},{-118,-16},{-118,22},
          {-108,22}},                             color={0,0,127}));
  connect(living_zone.TZone, PI_living.u_m)
    annotation(Line(points={{62,11.6},{62,-24},{30,-24},{30,-38},{-32,-38},{-32,
          -56},{-102,-56},{-102,2},{-96,2},{-96,10}},                   color={0,0,127}));
  connect(PI_living.y, valve_living.opening)
    annotation(Line(points={{-85,22},{-70,22},{-70,8},{-50,8}},           color={0,0,127}));
  connect(TRefConst_living.y, living_zone.TZoneRef)
    annotation(Line(points={{-147,-42},{-142,-42},{-142,-16},{-118,-16},{-118,58},
          {-110,58},{-110,84},{-88,84},{-88,92},{70,92},{70,58},{89.6,58},{89.6,
          40}},                                                                       color={0,0,127}));

  // Roof control loop
  connect(TRefConst_roof.y, PI_roof.u_s)
    annotation(Line(points={{-141,1},{-114,1},{-114,55},{-102,55}},
                                                  color={0,0,127}));
  connect(roof_zone.TZone, PI_roof.u_m)
    annotation(Line(points={{64,-79.4},{64,-88},{44,-88},{44,-72},{-100,-72},{-100,
          -36},{-80,-36},{-80,43},{-90,43}},                              color={0,0,127}));
  connect(PI_roof.y, valve_roof.opening)
    annotation(Line(points={{-79,55},{-70,55},{-70,40},{-50,40},{-50,33}}, color={0,0,127}));
  connect(TRefConst_roof.y, roof_zone.TZoneRef)
    annotation(Line(points={{-141,1},{-114,1},{-114,-94},{100,-94},{100,-76},{106,
          -76},{106,-32},{91.6,-32},{91.6,-51}},                                      color={0,0,127}));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ZONE INPUT CONNECTIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Window shading
  connect(WindowShadingConst_cellar.y, cellar_zone.WindowShading)
    annotation(Line(points={{61,150},{49.4,150},{49.4,115.2}},
                                                         color={0,0,127}));
  connect(WindowShadingConst_living.y, living_zone.WindowShading)
    annotation(Line(points={{61,30},{61,4},{49.4,4},{49.4,12.2}},
                                                      color={0,0,127}));
  connect(WindowShadingConst_roof.y, roof_zone.WindowShading)
    annotation(Line(points={{61,55},{66,55},{66,94},{146,94},{146,-46},{116,-46},
          {116,-82},{98,-82},{98,-90},{42,-90},{42,-78.8},{51.4,-78.8}},
                                                      color={0,0,127}));

  // Solar radiation
  connect(Q_radiation_cellar.y, cellar_zone.Q_radiation_W)
    annotation(Line(points={{41,160},{50,160},{50,141},{26,141}}, color={0,0,127}));
  connect(Q_radiation_living.y, living_zone.Q_radiation_W)
    annotation(Line(points={{41,40},{41,14},{30,14},{30,24},{26,24},{26,38}},
                                                              color={0,0,127}));
  connect(Q_radiation_roof.y, roof_zone.Q_radiation_W)
    annotation(Line(points={{41,65},{41,82},{14,82},{14,66},{-52,66},{-52,58},{-74,
          58},{-74,-38},{-98,-38},{-98,-53},{28,-53}},        color={0,0,127}));

  // Occupancy
  connect(nPersons_cellar, cellar_zone.nPersons)
    annotation(Line(points={{-220,180},{-200,180},{-200,190},{40,190},{40,147},{
          103.2,147}},                                                                    color={0,0,127}));
  connect(nPersons_living, living_zone.nPersons)
    annotation(Line(points={{-220,140},{-210,140},{-210,130},{30,130},{30,44},{103.2,
          44}},                                                                         color={0,0,127}));
  connect(nPersons_roof, roof_zone.nPersons)
    annotation(Line(points={{-220,118},{25,118},{25,-47},{105.2,-47}},                  color={0,0,127}));

  // Appliance loads
  connect(P_appliances_cellar_W, cellar_zone.P_appliances_W)
    annotation(Line(points={{230,180},{220,180},{220,149},{26,149}}, color={0,0,127}));
  connect(P_appliances_living_W, living_zone.P_appliances_W)
    annotation(Line(points={{230,140},{188,140},{188,2},{30,2},{30,12},{28,12},{
          28,26},{26,26},{26,46}},                                 color={0,0,127}));
  connect(P_appliances_roof_W, roof_zone.P_appliances_W)
    annotation(Line(points={{230,100},{194,100},{194,-14},{96,-14},{96,-22},{38,
          -22},{38,-16},{28,-16},{28,-45}},                        color={0,0,127}));

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // OUTPUT CONNECTIONS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  connect(cellar_zone.TZone, TZone_cellar)
    annotation(Line(points={{62,114.6},{210,114.6},{210,140}},
                                                           color={0,0,127}));
  connect(living_zone.TZone, TZone_living)
    annotation(Line(points={{62,11.6},{62,4},{190,4},{190,16},{210,16},{210,40}},
                                                        color={0,0,127}));
  connect(roof_zone.TZone, TZone_roof)
    annotation(Line(points={{64,-79.4},{64,-88},{114,-88},{114,-84},{210,-84},{210,
          -60}},                                         color={0,0,127}));

  connect(PI_cellar.y, valve_cellar_opening)
    annotation(Line(points={{-79,150},{-70,150},{-70,170},{190,170},{190,100},{210,100}}, color={0,0,127}));
  connect(PI_living.y, valve_living_opening)
    annotation(Line(points={{-85,22},{-70,22},{-70,-44},{228,-44},{228,0},{210,0}},
                                                                                  color={0,0,127}));
  connect(PI_roof.y, valve_roof_opening)
    annotation(Line(points={{-79,55},{-70,55},{-70,70},{180,70},{180,-140},{210,-140}}, color={0,0,127}));

  // Flow rate approximation
  connect(PI_cellar.y, qv_cellar_approx.u)
    annotation(Line(points={{-79,150},{118,150}}, color={0,0,127}));
  connect(PI_living.y, qv_living_approx.u)
    annotation(Line(points={{-85,22},{20,22},{20,30},{118,30}},
                                                color={0,0,127}));
  connect(PI_roof.y, qv_roof_approx.u)
    annotation(Line(points={{-79,55},{118,55}}, color={0,0,127}));

  connect(qv_cellar_approx.y, qvSum.u1)
    annotation(Line(points={{141,150},{150,150},{150,-92},{158,-92}}, color={0,0,127}));
  connect(qv_living_approx.y, qvSum.u2)
    annotation(Line(points={{141,30},{155,30},{155,-100},{158,-100}}, color={0,0,127}));
  connect(qv_roof_approx.y, qvSum.u3)
    annotation(Line(points={{141,55},{150,55},{150,-108},{158,-108}}, color={0,0,127}));

  connect(qvSum.y, qvRef)
    annotation(Line(points={{181,-100},{210,-100}}, color={0,0,127}));

  annotation(
    Icon(graphics={
      Rectangle(extent={{-100,-100},{100,100}}, lineColor={0,0,0}, fillColor={255,255,255}, fillPattern=FillPattern.Solid),
      Text(extent={{-80,90},{80,70}}, textString="OPTIMIZED", lineColor={0,0,255}),
      Text(extent={{-80,60},{80,40}}, textString="3-Zone Building", lineColor={0,0,0}),
      Rectangle(extent={{-80,30},{-40,-30}}, lineColor={255,0,0}, fillColor={255,200,200}, fillPattern=FillPattern.Solid),
      Text(extent={{-75,25},{-45,15}}, textString="Cellar", lineColor={0,0,0}),
      Rectangle(extent={{-30,30},{10,-30}}, lineColor={0,128,0}, fillColor={200,255,200}, fillPattern=FillPattern.Solid),
      Text(extent={{-25,25},{5,15}}, textString="Living", lineColor={0,0,0}),
      Rectangle(extent={{20,30},{60,-30}}, lineColor={0,0,255}, fillColor={200,200,255}, fillPattern=FillPattern.Solid),
      Text(extent={{25,25},{55,15}}, textString="Roof", lineColor={0,0,0}),
      Line(points={{-90,0},{-80,0}}, color={0,127,255}, thickness=1),
      Line(points={{60,0},{90,0}}, color={0,127,255}, thickness=1),
      Text(extent={{-100,-70},{100,-90}}, textString="Living Priority", lineColor={255,0,0})}),
    Documentation(info="<html>
<h4>ThreeZoneBuilding_optimized</h4>

<p><b>â­â­â­ PROFESSIONAL HVAC DESIGN with OPTIMIZED TOPOLOGY</b></p>

<h5>KEY IMPROVEMENTS:</h5>

<h6>1. OPTIMIZED HYDRAULIC TOPOLOGY:</h6>
<pre>
Supply â†’ teeMain
           â”œâ”€ port_2 â†’ valve_living â†’ living âœ… PRIORITY!
           â””â”€ port_3 â†’ teeCellarRoof
                          â”œâ”€ port_2 â†’ valve_cellar â†’ cellar
                          â””â”€ port_3 â†’ valve_roof â†’ roof

Living gets DIRECT connection = Maximum flow priority
Cellar and roof SHARE secondary branch = Natural flow limiting
</pre>

<h6>2. RIGHT-SIZED RADIATORS:</h6>
<ul>
<li><b>Living: 3500W</b> - Priority zone, adequate capacity</li>
<li><b>Cellar: 2500W</b> - â­ REDUCED from 4000W (was 60% oversized!)</li>
<li><b>Roof: 2500W</b> - Adequate for office use</li>
</ul>

<h6>3. OPTIMIZED VALVE MINIMUMS:</h6>
<ul>
<li><b>Living: 3%</b> (was 10%) - Very low, priority zone</li>
<li><b>Cellar: 5%</b> (was 20%) - â­ 75% REDUCTION!</li>
<li><b>Roof: 8%</b> (was 10%) - Moderate</li>
</ul>

<h5>WHY THIS WORKS:</h5>

<p><b>Cellar Heat Balance at 5% minimum (-2Â°C outdoor):</b></p>
<pre>
Heat Loss:
  Walls/floor: ~400W (underground, well-insulated)
  Infiltration: ~150W (0.15 ACH)
  TOTAL: ~550W

Heat Gain at 5%:
  Radiator: 0.05 Ã— 2500W = 125W
  Appliances: 50-200W
  TOTAL: 175-325W

NET: -225W to -375W (NEGATIVE!)

Result: Valve MUST open above 5% to maintain 18Â°C
Controller has FULL RANGE (5%-100%) to modulate âœ…
Temperature: Stable at 18-19Â°C âœ…
</pre>

<h5>PROFESSIONAL HVAC PRINCIPLES APPLIED:</h5>
<ol>
<li><b>Zone Prioritization:</b> Living (occupied) > Cellar (utility)</li>
<li><b>Differential Pressure Control:</b> High-demand zones limit others naturally</li>
<li><b>Right-Sizing:</b> Radiators matched to actual load (not oversized)</li>
<li><b>Controller Freedom:</b> Low minimums allow full modulation range</li>
</ol>

<h5>EXPECTED RESULTS:</h5>
<pre>
T_living:  20-21Â°C âœ… Perfect control
T_cellar:  18-20Â°C âœ… NO MORE OVERHEATING!
T_roof:    19-21Â°C âœ… Stable
valves:    Full modulation range âœ…
</pre>

<p><b>This is PRODUCTION-READY HVAC SYSTEM DESIGN!</b> ğŸ‰</p>
</html>"));
end ThreeZoneBuilding_optimized;
